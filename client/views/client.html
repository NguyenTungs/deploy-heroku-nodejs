<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.webrtc-experiment.com/style.css">
    <title>Change Video Resolutions in your Live Sessions using RTCMultiConnection</title>
    <meta name="description" content="Change video resolutions, change cameras, change microphones, change frame-rates seamlessly using RTCMultiConnection v3.0" />
    <meta name="keywords" content="WebRTC,RTCMultiConnection,Demos,Experiments,Samples,Examples" />
    <style>
    video {
        object-fit: fill;
        width: 30%;
    }
    
    button,
    input,
    select {
        font-weight: normal;
        padding: 2px 4px;
        text-decoration: none;
        display: inline-block;
        text-shadow: none;
        font-size: 16px;
        outline: none;
    }
    
    .make-center {
        text-align: center;
        padding: 5px 10px;
    }
    </style>
</head>

<body>
    <article>
        <header style="text-align: center;">
            <h1>Change Video Resolutions in your Live Sessions using RTCMultiConnection - by muaz-khan</h1>
        </header>
        <div class="github-stargazers"></div>
        <section class="experiment">
            <div class="make-center">
                <input type="text" id="room-id" value="abcdef">
                <button id="join-room">Join Room</button>
                <button id="open-or-join-room">Auto Open Or Join Room</button>
                <br>
                <br>
                <label for="video-width">Video Width:</label>
                <input id="video-width" value="1280">
                <br>
                <label for="video-height">Video Height:</label>
                <input id="video-height" value="720">
                <br>
                <br>
                <button id="btn-change-resolutions" disabled>Change Resolutions</button>
            </div>
            <div id="videos-container"></div>
        </section>
        <!-- <script src="/dist/rmc3.min.js"></script> -->
        <script src="https://cdn.webrtc-experiment.com:443/rmc3.min.js"></script>
        <!-- socket.io for signaling -->
        <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
        <script>
        // ......................................................
        // .......................UI Code........................
        // ......................................................
        document.getElementById('join-room').onclick = function() {
            this.disabled = true;
            connection.join(document.getElementById('room-id').value);
        };

        document.getElementById('open-or-join-room').onclick = function() {
            this.disabled = true;
            connection.openOrJoin(document.getElementById('room-id').value);
        };

        // ......................................................
        // ..................RTCMultiConnection Code.............
        // ......................................................

        var connection = new RTCMultiConnection();
        connection.enableLogs = false;

        // by default, socket.io server is assumed to be deployed on your own URL
        // connection.socketURL = '/';

        // comment-out below line if you do not have your own socket.io server
        connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

        connection.socketMessageEvent = 'change-resolutions-demo';

        var roomid = '';
        if (localStorage.getItem('rmc-room-id')) {
            roomid = localStorage.getItem('rmc-room-id');
        } else {
            roomid = connection.token();
        }
        document.getElementById('room-id').value = roomid;
        document.getElementById('room-id').onkeyup = function() {
            localStorage.setItem('rmc-room-id', this.value);
        };

        connection.session = {
            audio: true,
            video: true,
            oneway: true
        };

        connection.bandwidth = {
            audio: 192, // kbps
            video: 1024, // kbps
            screen: 1024 // kbps
        };

        connection.sdpConstraints.mandatory = {
            OfferToReceiveAudio: true,
            OfferToReceiveVideo: true
        };

        connection.videosContainer = document.getElementById('videos-container');


        connection.onstream = function(event) {

            console.info('event--client---', event);

            event.mediaElement.id = event.userid;
            connection.videosContainer.appendChild(event.mediaElement);
            event.mediaElement.play();
            setTimeout(function() {
                event.mediaElement.play();
            }, 5000);

            if (event.type !== 'remote') return;

            if (connection.DetectRTC.browser.name !== 'Chrome' && connection.DetectRTC.browser.name !== 'Firefox') {
                return;
            }

            document.getElementById('btn-change-resolutions').disabled = false;
        };

        // ......................................................
        // ..................applyConstraints Code...................
        // ......................................................

        document.getElementById('btn-change-resolutions').onclick = function() {
            this.disabled = true;
            connection.bandwidth = {
                audio: 192, // kbps
                video: 512, // kbps
                screen: 1024 // kbps
            };
            var width = parseInt(document.getElementById('video-width').value) || 1280;
            var height = parseInt(document.getElementById('video-height').value) || 720;

            if (connection.DetectRTC.browser.name === 'Chrome') {
                changeResolutionsInChrome(width, height);
                return;
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getSupportedConstraints) {
                alert('This feature is NOT available in your browser.');
                return;
            }

            var supports = navigator.mediaDevices.getSupportedConstraints();

            var constraints = {};
            if (supports.width && supports.height) {
                constraints = {
                    width: width,
                    height: height
                };
            }

            connection.applyConstraints({
                video: constraints
            });

            this.disabled = false;
        };

        function changeResolutionsInChrome(width, height) {


            if (document.getElementById(connection.userid)) {
                document.getElementById(connection.userid).style.display = 'none';
            }

            connection.mediaConstraints.video.mandatory = {
                maxWidth: width,
                maxHeight: height
            };

            connection.getAllParticipants().forEach(function(p) {

                var user = connection.peers[p];

                user.peer.getLocalStreams().forEach(function(localStream) {

                    user.peer.removeStream(localStream);
                });
            });

            var oldStream = connection.attachStreams[0];


            // connection.renegotiate();

            navigator.webkitGetUserMedia(connection.mediaConstraints, function(newStream) {
                connection.attachStreams = [newStream];

                var video = document.createElement('video');
                video.src = URL.createObjectURL(newStream);
                connection.videosContainer.appendChild(video);

                video.play();

                setTimeout(function() {
                    video.play();
                    oldStream.stop();

                    setTimeout(function() {
                        video.id = connection.userid;
                        document.getElementById('btn-change-resolutions').disabled = false;
                    }, 2000);
                }, 5000);

                connection.renegotiate();
            }, function(error) {
                alert(JSON.stringify(error, null, '\t'));
            });
        }
        </script>
</body>

</html>
