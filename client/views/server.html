<!--
> Muaz Khan     - github.com/muaz-khan 
> MIT License   - www.webrtc-experiment.com/licence
> Documentation - www.RTCMultiConnection.org
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>WebRTC Broadcasting using RTCMultiConnection Â® Muaz Khan</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="author" type="text/html" href="https://plus.google.com/+MuazKhan">
    <meta name="author" content="Muaz Khan">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="//cdn.webrtc-experiment.com/style.css">
    <style>
    audio,
    video {
        -moz-transition: all 1s ease;
        -ms-transition: all 1s ease;
        -o-transition: all 1s ease;
        -webkit-transition: all 1s ease;
        transition: all 1s ease;
        vertical-align: top;
        width: 100%;
    }
    
    input {
        border: 1px solid #d9d9d9;
        border-radius: 1px;
        font-size: 2em;
        margin: .2em;
        width: 30%;
    }
    
    .setup {
        border-bottom-left-radius: 0;
        border-top-left-radius: 0;
        font-size: 102%;
        height: 47px;
        margin-left: -9px;
        margin-top: 8px;
        position: absolute;
    }
    
    p {
        padding: 1em;
    }
    
    li {
        border-bottom: 1px solid rgb(189, 189, 189);
        border-left: 1px solid rgb(189, 189, 189);
        padding: .5em;
    }
    </style>
    <script>
    document.createElement('article');
    document.createElement('footer');
    </script>
    <!-- scripts used for broadcasting -->
    <script src="//cdn.webrtc-experiment.com/firebase.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//cdn.webrtc-experiment.com/RTCMultiConnection.js" type="text/javascript"></script>
</head>

<body>
    <div class="github-stargazers"></div>
    <!-- just copy this <section> and next script -->
    <section class="experiment">
        <section>
            <input type="text" id="broadcast-name" value="tungns">
            <button id="setup-new-broadcast" class="setup" style="margin-left: 2%;">Setup New Broadcast</button>
            <button id="add-screen" class="setup" style="margin-left: 20%;">Add Screen</button>
            <!-- <button id="remove-screen" class="setup" style="margin-left: 35%;">Remove Screen</button> -->
        </section>
        <div style="position: fixed;left: 20%;right: 20%;text-align: center;">
            <button id="start" contenteditable="false">Start Canvas Recording</button>
            <button id="stop" contenteditable="false">Stop</button>
        </div>
        <!-- local/remote videos container -->
        <div id="videos-container" style="width: 40%">
        </div>
    </section>
    <script>
    var connection = new RTCMultiConnection('tungns-demo');
    connection.enableLogs = false;
    connection.session = {
        audio: true,
        video: true,
        oneway: true
    };

    connection.bandwidth = {
        audio: 192,
        video: 1024,
        data: 1638400,
        screen: 1024 // 300kbps
    };

    var mainSocket = io.connect("//localhost:3000");



    var oldStreamScreen = null,
        oldStream;

    connection.onstream = function(e) {
        console.info('e----', e);
        if (e.isScreen) {
            console.info('e--isScreen--', e);
            oldStreamScreen = e.streamid;
        }
        oldStream = e.stream;
        e.mediaElement.width = 600;
        videosContainer.insertBefore(e.mediaElement, videosContainer.firstChild);
        rotateVideo(e.mediaElement);
        scaleVideos();
    };

    function rotateVideo(mediaElement) {
        mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
        setTimeout(function() {
            mediaElement.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
        }, 1000);
    }

    connection.onstreamended = function(e) {
        e.mediaElement.style.opacity = 0;
        rotateVideo(e.mediaElement);
        setTimeout(function() {
            if (e.mediaElement.parentNode) {
                e.mediaElement.parentNode.removeChild(e.mediaElement);
            }
            scaleVideos();
        }, 1000);
    };


    var videosContainer = document.getElementById('videos-container') || document.body;
    var roomsList = document.getElementById('rooms-list');

    // document.getElementById('remove-screen').onclick = function() {
    //     //connection.removeStream('screen');
    //     if(oldStreamScreen !== null){
    //         connection.removeStream(oldStreamScreen);
    //     }

    //     document.getElementById('add-screen').disabled = false;
    // }

    document.getElementById('add-screen').onclick = function() {
        this.disabled = true;
        connection.sdpConstraints.mandatory = {
            OfferToReceiveAudio: true,
            OfferToReceiveVideo: true
        };

        connection.addStream({
            screen: true,
            oneway: true
        });
    }

    document.getElementById('setup-new-broadcast').onclick = function() {
        this.disabled = true;

        connection.open(document.getElementById('broadcast-name').value || 'Anonymous');
    };

    // setup signaling to search existing sessions
    connection.connect();

    (function() {
        var uniqueToken = document.getElementById('unique-token');
        if (uniqueToken)
            if (location.hash.length > 2) uniqueToken.parentNode.parentNode.parentNode.innerHTML = '<h2 style="text-align:center;"><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
            else uniqueToken.innerHTML = uniqueToken.parentNode.parentNode.href = '#' + (Math.random() * new Date().getTime()).toString(36).toUpperCase().replace(/\./g, '-');
    })();

    function scaleVideos() {
        var videos = document.querySelectorAll('video'),
            length = videos.length,
            video;

        var minus = 130;
        var windowHeight = 700;
        var windowWidth = 600;
        var windowAspectRatio = windowWidth / windowHeight;
        var videoAspectRatio = 4 / 3;
        var blockAspectRatio;
        var tempVideoWidth = 0;
        var maxVideoWidth = 0;

        for (var i = length; i > 0; i--) {
            blockAspectRatio = i * videoAspectRatio / Math.ceil(length / i);
            if (blockAspectRatio <= windowAspectRatio) {
                tempVideoWidth = videoAspectRatio * windowHeight / Math.ceil(length / i);
            } else {
                tempVideoWidth = windowWidth / i;
            }
            if (tempVideoWidth > maxVideoWidth)
                maxVideoWidth = tempVideoWidth;
        }
        for (var i = 0; i < length; i++) {
            video = videos[i];
            if (video)
                video.width = maxVideoWidth - minus;
        }
    }

    window.onresize = scaleVideos;
    </script>
    <script src="https://cdn.WebRTC-Experiment.com/RecordRTC.js"></script>
    <script src="https://cdn.webrtc-experiment.com/screenshot.js"></script>
    <script>
    var recordVideoSeparately = !!navigator.webkitGetUserMedia;
    var elementToShare = document.getElementById('videos-container');
    var recordAudio, recordVideo;

    document.getElementById('start').onclick = function() {
        console.info('oldStream--', oldStream);
        var options = {
            type: 'canvas',
            video: {
                width: 1280,
                height: 720
            },
            canvas: {
                width: 1280,
                height: 720
            }
        };
        document.getElementById('start').disabled = true;
        recordVideo = RecordRTC(elementToShare, {
            type: 'canvas'
        });
        recordAudio = RecordRTC(oldStream, {
            type: 'audio'
        });
        recordVideo.startRecording();
        recordAudio.startRecording();
    };
    document.getElementById('stop').onclick = function() {
        this.disabled = true;
        recordVideoSeparately && recordAudio.stopRecording(function() {
            // stop video recorder
            recordVideo.stopRecording(function() {
                // get audio data-URL
                recordAudio.getDataURL(function(audioDataURL) {
                    // get video data-URL
                    recordVideo.getDataURL(function(videoDataURL) {
                        var files = {
                            audio: {
                                type: recordAudio.getBlob().type || 'audio/wav',
                                dataURL: audioDataURL
                            },
                            video: {
                                type: recordVideo.getBlob().type || 'video/webm',
                                dataURL: videoDataURL
                            }
                        };

                        mainSocket.emit('message', files);

                    });

                });
            });
        });
    };
    </script>
</body>

</html>
